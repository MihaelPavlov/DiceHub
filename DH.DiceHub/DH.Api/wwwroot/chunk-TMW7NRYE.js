import{a as re}from"./chunk-DTF2TMHG.js";import{a as X}from"./chunk-GCHHXTRN.js";import{a as l}from"./chunk-IGE7THSU.js";import{a as $,b as K,c as Y,d as B,e as z}from"./chunk-257RNC4W.js";import{a as H}from"./chunk-ELPMLOTJ.js";import{c as J,d as W}from"./chunk-S4L6UGIL.js";import{Aa as R,Ca as V,E as T,Ea as P,Ec as A,Fa as C,Gc as L,Kc as U,L as j,La as F,M as u,Ma as k,Na as q,Nc as Q,O as N,Pa as a,Qa as G,Ra as b,S as y,T as h,Vc as E,W as O,X as D,e as ae,ia as d,ja as m,oa as S,qa as f,qb as M,wa as r,xa as c,ya as v,yc as I,za as x}from"./chunk-JJGLVIRE.js";var ee=ae(re());function le(i,e){if(i&1&&(x(0),r(1,"h3",4),a(2),c(),r(3,"h4",5),a(4),c(),R()),i&2){let p=C();d(2),b("Problem with the ",p.getTypeOfQrCode," !"),d(2),G(p.data.errorMessage)}}function de(i,e){i&1&&(x(0),r(1,"h3",4),a(2,"Reward is valid!"),c(),r(3,"h4",4),a(4," Please confirm when you give the reward to the customer! "),c(),R())}function me(i,e){if(i&1){let p=V();r(0,"button",6),P("click",function(){O(p);let t=C();return D(t.confirm())}),a(1," Confirm "),c()}}var w=(()=>{let e=class e{constructor(n,t,o,g){this.data=n,this.dialogRef=t,this.rewardsService=o,this.toastService=g,this.QrCodeType=l,console.log("user reward data -> ",n)}get getTypeOfQrCode(){switch(this.data.type){case l.Reward:return"Reward";case l.GameReservation:return"Game Reservation";case l.Game:return"Game";case l.Event:return"Event";default:return"Qr-Code"}}confirm(){this.rewardsService.userRewardConfirmation(this.data.objectId).subscribe({next:()=>{this.toastService.success({message:"Successfully claimed",type:I.Success}),this.dialogRef.close(!0)},error:()=>{this.toastService.success({message:"Something went wrong",type:I.Error}),this.dialogRef.close(!0)}})}};e.\u0275fac=function(t){return new(t||e)(m(K),m($),m(X),m(H))},e.\u0275cmp=y({type:e,selectors:[["scan-result-admin-dialog"]],decls:7,vars:3,consts:[[1,"dialog-container"],[4,"ngIf"],["mat-dialog-close","",1,"btn","btn__small","btn-blue"],["class","btn btn__small btn-red btn-border-red",3,"click",4,"ngIf"],[1,"dialog-container__header","m-4"],[1,"dialog-container__header","error"],[1,"btn","btn__small","btn-red","btn-border-red",3,"click"]],template:function(t,o){t&1&&(r(0,"div",0),S(1,le,5,2,"ng-container",1)(2,de,5,0,"ng-container",1),r(3,"mat-dialog-actions")(4,"button",2),a(5,"Close"),c(),S(6,me,2,0,"button",3),c()()),t&2&&(d(),f("ngIf",!o.data.isValid),d(),f("ngIf",o.data.isValid&&o.data.type===o.QrCodeType.Reward),d(4),f("ngIf",o.data.isValid))},dependencies:[M,z,B],styles:[".dialog-container[_ngcontent-%COMP%]{color:#fff;background-color:#31313b}.dialog-container__header[_ngcontent-%COMP%]{margin:1rem}.dialog-container[_ngcontent-%COMP%]   .error[_ngcontent-%COMP%]{color:#bf3c65}.dialog-container[_ngcontent-%COMP%]   mat-dialog-actions[_ngcontent-%COMP%]{display:flex;justify-content:end}.dialog-container[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{margin:.4rem}"]});let i=e;return i})();var Z=(()=>{let e=class e{constructor(n){this.api=n}upload(n){return this.api.post(`/${A.SCANNER.CORE}/${A.SCANNER.UPLOAD}`,n)}};e.\u0275fac=function(t){return new(t||e)(N(L))},e.\u0275prov=j({token:e,factory:e.\u0275fac,providedIn:"root"});let i=e;return i})();var pe=["video"];function ge(i,e){i&1&&(r(0,"span",5),a(1,"QR Code is invalid! "),v(2,"br"),a(3," Contact the "),r(4,"strong"),a(5,"STAFF"),c(),a(6," if you "),r(7,"strong"),a(8,"scan QR Code from a game"),c()())}function ue(i,e){if(i&1&&(r(0,"pre",6),a(1,"QR Code is valid! "),v(2,"br"),a(3),c()),i&2){let p=C();d(3),b(`
  `,p.afterScanSuccessfulMessage,"")}}function he(i,e){i&1&&(r(0,"div",7),v(1,"video",8,0),c())}var te=(()=>{let e=class e{constructor(n,t,o){this.scannerService=n,this.router=t,this.dialog=o,this.currentStream=null,this.KEY_AFTER_SCAN_SUCCESS_MESSAGE="afterScanSuccessMessage",this.imageSrc=null,this.invalidQrCode=!1,this.isValidQrScanned=!1,this.afterScanSuccessfulMessage=null}ngOnInit(){this.initAfterScanSuccessMessage()}ngAfterViewInit(){this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),this.startCamera()}startCamera(){navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}}).then(n=>{try{this.videoElement.nativeElement.srcObject=n,this.videoElement.nativeElement.play(),requestAnimationFrame(this.tick.bind(this))}catch(t){alert(t)}}).catch(n=>{alert(n),console.log(n)})}tick(){if(!this.videoElement)return;let n=this.videoElement.nativeElement;if(n.readyState===n.HAVE_ENOUGH_DATA){this.context?.drawImage(n,0,0,this.canvas.width,this.canvas.height);let t=this.context?.getImageData(0,0,this.canvas.width,this.canvas.height);if(t){let o=(0,ee.default)(t.data,t.width,t.height);if(o)if(console.log("QR Code detected:",o.data),this.afterScanSuccessfulMessage=null,n.pause(),!this.isQrCodeValid(o.data))console.log("Invalid QR Code detected:",o.data),this.invalidQrCode=!0,n.play();else{this.invalidQrCode=!1;let g={data:o.data};this.isValidQrScanned=!0,this.scannerService.upload(g).pipe(T(1)).subscribe({next:s=>{if(s)switch(s.type){case l.Game:s.isValid&&this.router.navigateByUrl(`space/create/${s.objectId}`);break;case l.GameReservation:s.isValid?(this.setLocalStorageSuccessMessage(`Game Reservation is VALID 

 ${s.internalNote??"No Note From Staff"}`),window.location.reload()):this.dialog.open(w,{data:s}).afterClosed().subscribe({next:()=>{window.location.reload()}});break;case l.TableReservation:s.isValid?(this.setLocalStorageSuccessMessage(`Table Reservation is VALID 

 ${s.internalNote??"No Note From Staff"}`),window.location.reload()):this.dialog.open(w,{data:s}).afterClosed().subscribe({next:()=>{window.location.reload()}});break;case l.Reward:this.dialog.open(w,{data:s}).afterClosed().subscribe({next:()=>{window.location.reload()}});break}},error:s=>{console.log(s,"error"),this.invalidQrCode=!0,this.isValidQrScanned=!1,this.startCamera()}})}}requestAnimationFrame(this.tick.bind(this))}else setTimeout(this.tick.bind(this),10)}isQrCodeValid(n){let t;console.log(n);try{t=JSON.parse(n)}catch{return!1}return!!(t&&t.Id!==0&&t.Name&&t.Name.trim()!==""&&Object.values(l).includes(t.Type))}setLocalStorageSuccessMessage(n){this.afterScanSuccessfulMessage=n,localStorage.setItem(this.KEY_AFTER_SCAN_SUCCESS_MESSAGE,this.afterScanSuccessfulMessage)}initAfterScanSuccessMessage(){let n=localStorage.getItem(this.KEY_AFTER_SCAN_SUCCESS_MESSAGE);n&&(this.afterScanSuccessfulMessage=n,localStorage.removeItem(this.KEY_AFTER_SCAN_SUCCESS_MESSAGE))}};e.\u0275fac=function(t){return new(t||e)(m(Z),m(U),m(Y))},e.\u0275cmp=y({type:e,selectors:[["app-qr-code-scanner"]],viewQuery:function(t,o){if(t&1&&F(pe,5),t&2){let g;k(g=q())&&(o.videoElement=g.first)}},decls:4,vars:4,consts:[["video",""],["header","Scan QR Code",3,"withBottomLine"],["class","qr_code_error",4,"ngIf"],["class","after_scan_success_message",4,"ngIf"],["class","qr_video_container",4,"ngIf"],[1,"qr_code_error"],[1,"after_scan_success_message"],[1,"qr_video_container"],["width","700","height","700","autoplay",""]],template:function(t,o){t&1&&(v(0,"app-header",1),S(1,ge,9,0,"span",2)(2,ue,4,1,"pre",3)(3,he,3,0,"div",4)),t&2&&(f("withBottomLine",!0),d(),f("ngIf",o.invalidQrCode),d(),f("ngIf",o.afterScanSuccessfulMessage),d(),f("ngIf",!o.isValidQrScanned))},dependencies:[M,J],styles:[".qr_video_container[_ngcontent-%COMP%]{display:flex;justify-content:center;margin:2rem}.qr_video_container[_ngcontent-%COMP%]   video[_ngcontent-%COMP%]{width:90%;height:10%}.qr_code_error[_ngcontent-%COMP%]{display:flex;justify-content:center;color:#bf3c65;text-align:center;margin:1rem;font-size:1.2rem}.qr_code_error[_ngcontent-%COMP%]   strong[_ngcontent-%COMP%]{display:contents}.after_scan_success_message[_ngcontent-%COMP%]{text-align:center;display:flex;justify-content:center;font-size:1.25rem;margin:2rem;text-wrap:auto;color:#75a0ff}"]});let i=e;return i})();var Se=[{path:"",component:te}],ie=(()=>{let e=class e{};e.\u0275fac=function(t){return new(t||e)},e.\u0275mod=h({type:e}),e.\u0275inj=u({imports:[Q.forChild(Se),Q]});let i=e;return i})();var ne=(()=>{let e=class e{};e.\u0275fac=function(t){return new(t||e)},e.\u0275mod=h({type:e}),e.\u0275inj=u({imports:[E]});let i=e;return i})();var Ke=(()=>{let e=class e{};e.\u0275fac=function(t){return new(t||e)},e.\u0275mod=h({type:e}),e.\u0275inj=u({imports:[E,ie,W,ne]});let i=e;return i})();export{Ke as QrCodeScannerModule};
